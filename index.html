<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">

    
    <link rel="icon" href="/music/assets/images/favicon.ico" type="image/x-icon">
    <title>KnightChaser's Music Curation</title>

    <link rel="stylesheet" href="/music/assets/css/style.css">
  </head>
  <body class="font-sans bg-white text-gray-800">
    
<header class="relative">
  <!-- Site title -->
  <h1 class="mt-4 text-2xl font-bold text-center">
    KnightChaser's Music Curation List
  </h1>

  <!-- GitHub link in the top-right -->
  <a href="https://github.com/KnightChaser/music" target="_blank" aria-label="Music Repo on GitHub" class="absolute top-4 right-4">
    <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub" class="w-8 h-8">
  </a>
</header>


<div id="count" class="text-center mb-2 text-base text-gray-600">
  0 / 0 songs shown
</div>


<div class="flex justify-center my-6 px-4">
  <div class="relative w-full max-w-4xl">
    <!-- Search field wrapper -->
    <div class="relative">
      <!-- Left search icon -->
      <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
          <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"></path>
        </svg>
      </div>

      <input id="search" type="text" placeholder="artist:…, tag:…, note:…, language:…" autocomplete="off" class="block w-full pl-12 pr-24 py-4 text-xl text-gray-900
               border border-red-500 rounded-lg
               focus:border-red-600 focus:ring-red-600 transition">

      <!-- Reset button -->
      <button id="clear" type="button" class="absolute inset-y-0 right-0 flex items-center justify-center
               px-6 py-4 bg-red-600 text-white rounded-r-lg
               hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-200
               transition">
        reset
      </button>

      <!-- Suggestions dropdown -->
      <div id="suggestions" class="absolute z-50 mt-1 w-full max-h-80 overflow-auto rounded-b-lg
               border border-t-0 border-gray-300 bg-white shadow-lg" style="display: none;"></div>
    </div>
  </div>
</div>

<div class="px-4 sm:px-6 lg:px-8">
  <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
    <table id="resultsTable" class="w-full text-lg text-black bg-white border-collapse border border-gray-200">
      <thead class="text-lg text-black uppercase bg-gray-100">
        <tr>
          <th scope="col" data-key="artist" class="w-2/12 sortable px-6 py-3 text-center border-b border-gray-200">
            <div class="flex items-center justify-center">
              Artist
              <span class="sort-indicator ml-1">⇅</span>
            </div>
          </th>
          <th scope="col" data-key="title" class="w-3/12 sortable px-6 py-3 text-center border-b border-gray-200">
            <div class="flex items-center justify-center">
              Song
              <span class="sort-indicator ml-1">⇅</span>
            </div>
          </th>
          <th scope="col" data-key="release" class="w-1/12 sortable px-6 py-3 text-center border-b border-gray-200">
            <div class="flex items-center justify-center">
              Release
              <span class="sort-indicator ml-1">⇅</span>
            </div>
          </th>
          <th scope="col" class="w-3/12 px-6 py-3 text-center border-b border-gray-200">
            Tags
          </th>
          <th scope="col" class="w-2/12 px-6 py-3 text-center border-b border-gray-200">
            Note
          </th>
          <th scope="col" data-key="language" class="w-1/12 sortable px-6 py-3 text-center border-b border-gray-200">
            <div class="flex items-center justify-center">
              Language
              <span class="sort-indicator ml-1">⇅</span>
            </div>
          </th>
        </tr>
      </thead>
      <tbody class="divide-y">
        <tr>
          <td colspan="6" class="px-6 py-4 text-center text-black/50">
            Loading…
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>


<button id="backToTop" aria-label="Back to top" class="fixed bottom-6 right-6 w-12 h-12 bg-red-600 text-white rounded-full shadow-md
         flex items-center justify-center opacity-0 pointer-events-none
         transition-opacity duration-300 ease-in-out">
  TOP
</button>

<script>
const btn = document.getElementById('backToTop');
window.addEventListener('scroll', () => {
  if (window.scrollY > 300) {
    btn.classList.remove('opacity-0', 'pointer-events-none');
    btn.classList.add('opacity-100', 'pointer-events-auto');
  } else {
    btn.classList.remove('opacity-100', 'pointer-events-auto');
    btn.classList.add('opacity-0', 'pointer-events-none');
  }
});
btn.addEventListener('click', () => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
});
</script>


<script>
  const langEmoji = {
    en: '🇺🇸', pt: '🇵🇹', ja: '🇯🇵', es: '🇪🇸', fr: '🇫🇷',
    ko: '🇰🇷', ru: '🇷🇺', zh: '🇨🇳'
  };
  const langNames = {
    en: ['English'], pt: ['Português', 'Portuguese'], ja: ['日本語', 'Japanese'],
    es: ['Español', 'Spanish'], fr: ['Français', 'French'],
    ko: ['한국어', 'Korean'], ru: ['Русский', 'Russian'], zh: ['中文', 'Chinese']
  };

  function parseCriteria(str) {
    return str.split(',').map(s => s.trim()).filter(s => s.includes(':')).reduce((a,p) => {
      const [k, ...r] = p.split(':');
      const key = k.trim().toLowerCase();
      const val = r.join(':').trim().toLowerCase();
      if (key && val) a[key] = val;
      return a;
    }, {});
  }

  function filterData(data, criteria) {
    return data.filter(item => Object.entries(criteria).every(([k,v]) => {
      switch (k) {
        case 'artist': return item.artist.toLowerCase().includes(v);
        case 'title': return item.title.toLowerCase().includes(v);
        case 'release': return item.release.toLowerCase().includes(v);
        case 'tags': return item.tags.some(t => t.toLowerCase().includes(v));
        case 'note': return (item.note||'').toLowerCase().includes(v);
        case 'language': return item.language && item.language.toLowerCase() === v;
        default: return false;
      }
    }));
  }

  fetch('/music/search.json')
    .then(r => r.json())
    .then(data => {
      const input = document.getElementById('search');
      const clearBtn = document.getElementById('clear');
      const suggestionsBox = document.getElementById('suggestions');
      const total = data.length;
      const tbody = document.querySelector('#resultsTable tbody');
      const countEl = document.getElementById('count');
      const tagCounts = data.flatMap(d=>d.tags)
        .reduce((a,t)=>(a[t]=(a[t]||0)+1,a),{});
      const artistCounts = data.reduce((a,d)=>(a[d.artist]=(a[d.artist]||0)+1,a),{});
      const languageCounts = data.reduce((a,d)=>(d.language&&(a[d.language]=(a[d.language]||0)+1),a),{});
      const countsMap = { tags: tagCounts, artist: artistCounts, language: languageCounts };


      const sources = {
        artist: Array.from(new Set(data.map(d => d.artist))).sort(),
        title: Array.from(new Set(data.map(d => d.title))).sort(),
        tags: Array.from(new Set(data.flatMap(d => d.tags))).sort(),
        language: Array.from(new Set(data.map(d => d.language).filter(l => l))).sort(),
        note: Array.from(new Set(data.map(d => d.note).filter(n => n))).sort()
      };


      let current = [];
      let sortKey = 'release', sortDir = -1;
      let selectedIndex = -1;

      function updateCount() {
        countEl.textContent = `${current.length} / ${total} songs shown`;
      }

      function applySort() {
        current.sort((a, b) => {
          let av = a[sortKey], bv = b[sortKey];
          if (sortKey === 'release') {
            av = new Date(av);
            bv = new Date(bv);
          } else {
            av = String(av).toLowerCase();
            bv = String(bv).toLowerCase();
          }
          return (av < bv ? -1 : av > bv ? 1 : 0) * sortDir;
        });
      }

      function render() {
        if (!current.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align:center;">No matches</td>
            </tr>`;
          updateCount();
          return;
        }
        tbody.innerHTML = current.map(item => {
          const tagsHtml = item.tags.slice().sort().map(t =>
            `
            <span class="clickable inline-block bg-blue-100 rounded px-2 py-1 font-bold hover:bg-blue-200 cursor-pointer transition-colors" data-field="tags" data-term="${t}">#${t} (${tagCounts[t]})</span>`
          ).join(' ');

          const listenHtml = (item.listen || []).map(entry => {
            const key = Object.keys(entry)[0];
            const url = entry[key];
            let emoji = '', bg = '', color = '#000';

            if (key === 'ORG')            { emoji = '🎧'; bg = '#e0e0e0'; }
            else if (key.startsWith('RX')){ emoji = '🔀'; bg = '#e0f7fa'; color = '#006064'; }
            else if (key === 'NCR')       { emoji = '⚡'; bg = '#fff8e1'; color = '#ff6f00'; }

            const hover = key === 'ORG'
              ? 'Listen to the original song'
              : key.startsWith('RX')
                ? `Listen to the remix version${ key.includes('(') ? ' (' + key.match(/\((.*)\)/)[1] + ')' : '' }`
                : 'Listen to the nightcore version';

             return `
              <span class="relative inline-block group">
                <a
                  href="${url}"
                  class="rounded px-2 py-1 font-bold text-sm transition-colors group-hover:bg-blue-300 cursor-pointer clickable"
                  style="background:${bg}; color:${color};"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  ${key} ${emoji}
                </a>
                <div
                  class="absolute bottom-full mb-1 left-1/2 transform -translate-x-1/2
                         hidden group-hover:block bg-gray-800 text-white text-xs
                         rounded p-2 px-4 w-max max-w-sm whitespace-pre-line text-center z-10">${hover}</div>
              </span>
            `;
          }).join(' ');

          const lang = item.language || '';
          const names = langNames[lang] || ['', ''];
          const titleAttr = names.join('\n');
          const badge = lang
            ? `
              <span class="relative inline-block group">
                <!-- the pill itself -->
                <span
                  class="clickable inline-block bg-blue-100 rounded px-2 py-1 font-bold hover:bg-blue-200 cursor-pointer transition-colors lang-badge"
                  data-field="language"
                  data-term="${lang}"
                >
                  ${lang}${langEmoji[lang] || ''}
                </span>
                <!-- tooltip: hidden until hover -->
                <div
                  class="absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2
                         hidden group-hover:block px-2 py-1 text-sm text-white bg-gray-800
                         rounded whitespace-pre-line text-center z-10"
                > ${langEmoji[lang] || ''}
                  ${langNames[lang][0]}
                    ${lang !== 'en'
                    ? `${langNames[lang][1] || langNames[lang][0]} (${lang})`
                    : `(${lang})`}
                </div>
              </span>
            `
            : '';

          return `
            <tr>
              <td class="px-6 py-4 text-center">
                <span class="clickable inline-block bg-blue-100 rounded px-2 py-1 font-bold hover:bg-blue-200 cursor-pointer transition-colors" data-field="artist" data-term="${item.artist}" style="margin-right:0.25rem; margin-bottom:0.15rem;">${item.artist}</span>
              </td>
              <td class="px-6 py-4 text-center align-center">
                <!-- SONG title a bit larger -->
                <div class="text-xl font-semibold">${item.title}</div>
                <!-- badges stacked, centered, with a little gap -->
                <div class="mt-2 flex flex-col items-center space-y-1">
                  ${listenHtml}
                </div>
              </td>
              <td class="px-6 py-4 text-center whitespace-nowrap">
                   ${item.release}
              </td>
              <td class="px-6 py-4 text-left">
                   ${item.tags.slice().sort().map(t =>
                    `<span class="clickable inline-block bg-blue-100 rounded px-2 py-1 font-bold hover:bg-blue-200 cursor-pointer transition-colors" data-field="tags" data-term="${t}" style="margin-right:0.25rem; margin-bottom:0.15rem;">#${t} (${tagCounts[t]})</span>`
                   ).join(' ')}
              </td>
              <td class="px-6 py-4 text-left">
                   ${item.note || 'N/A'}
              </td>
              <td class="px-6 py-4 text-center">
                   ${badge}
              </td>
            </tr>`;
        }).join('');
        updateCount();
      }

      function doSearch() {
        const criteria = parseCriteria(input.value);
        current = filterData(data, criteria);
        applySort();
        render();
        suggestionsBox.style.display = 'none'; // Hide suggestions after search
      }

      function updateSuggestions() {
        const raw = input.value;
        const lastSeg = raw.includes(',')
          ? raw.slice(raw.lastIndexOf(',') + 1).trim()
          : raw.trim();
        const m = lastSeg.match(/^(\w+):\s*([^,]*)$/);

        if (!m) {
          suggestionsBox.style.display = 'none';
          return;
        }

        const field = m[1].toLowerCase();
        const term  = m[2].toLowerCase();
        const countsMap = { artist: artistCounts, tags: tagCounts, language: languageCounts };
        const rawList   = sources[field] || [];
        const counts    = countsMap[field] || {};

        const matches = rawList
          .filter(v => v.toLowerCase().startsWith(term))
          .sort((a, b) => (counts[b] || 0) - (counts[a] || 0) || a.localeCompare(b))
          .slice(0, 50);

        if (!matches.length) {
          suggestionsBox.style.display = 'none';
          return;
        }

        suggestionsBox.innerHTML = matches.map((v, i) => {
          return `
            <div
              data-val="${field}:${v}"
              data-index="${i}"
              tabindex="0"
              class="flex justify-between px-4 py-2 hover:bg-gray-100 cursor-pointer"
            >
              <span><strong>${field}:</strong> ${v}</span>
              <span class="ml-2 text-gray-500">(${counts[v] || 0})</span>
            </div>
          `;
        }).join('');

        selectedIndex = -1;
        suggestionsBox.style.display = 'block';
      }

      // Event Listeners
      input.addEventListener('input', () => {
        doSearch();
        updateSuggestions();
      });

      input.addEventListener('keydown', e => {
        const items = Array.from(suggestionsBox.children);
        if (!items.length || suggestionsBox.style.display !== 'block') return;
      
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
          e.preventDefault();
          let idx = selectedIndex;
          if (e.key === 'ArrowDown')   idx = (idx + 1) % items.length;
          else if (e.key === 'ArrowUp') idx = (idx - 1 + items.length) % items.length;
      
          // clear, highlight, and scroll into view
          items.forEach(i => i.classList.remove('bg-gray-200'));
          items[idx].classList.add('bg-gray-200');
          items[idx].scrollIntoView({ block: 'nearest' });
      
          selectedIndex = idx;
        } else if (e.key === 'Enter' && selectedIndex > -1) {
          e.preventDefault();
          items[selectedIndex].click();
          selectedIndex = -1;
        }
      });

      clearBtn.addEventListener('click', () => {
        input.value = '';
        doSearch();
        suggestionsBox.style.display = 'none';
        input.focus();
      });

      suggestionsBox.addEventListener('click', e => {
        const val = e.target.closest('div')?.dataset.val;
        if(val){
          const parts = input.value.split(',').map(s => s.trim()).filter(s => s);
          const [field, term] = val.split(':');
          const filtered = parts.filter(p => !p.toLowerCase().startsWith(field + ':'));
          input.value = filtered.join(', ') + (filtered.length ? ', ' : '') + val;
          doSearch(); // Perform search immediately after selecting a suggestion
          suggestionsBox.style.display = 'none'; // Hide suggestions after selection
        }
      });

      // Initial render on page load
      doSearch();

      document.querySelectorAll('th.sortable').forEach(th => th.addEventListener('click', () => {
        const key = th.dataset.key;
        if (sortKey === key) sortDir *= -1;
        else { sortKey = key; sortDir = 1; }
        document.querySelectorAll('th.sortable').forEach(h => h.style.fontWeight = 'normal');
        th.style.fontWeight = 'bold';
        applySort();
        render();
      }));

      document.querySelector('#resultsTable tbody').addEventListener('click', e => {
        if (e.target.classList.contains('clickable') && e.target.dataset.field) {
          const f = e.target.dataset.field, t = e.target.dataset.term;
          const parts = input.value.split(',').map(s => s.trim()).filter(s => s);
          const filtered = parts.filter(p => !p.toLowerCase().startsWith(f + ':'));
          filtered.push(`${f}:${t}`);
          input.value = filtered.join(', ');
          doSearch();
        }
      });

      const btn = document.getElementById('backToTop');
      window.addEventListener('scroll', () => { btn.style.display = window.scrollY > 300 ? 'block' : 'none'; });
      btn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
    });

</script>

    <script src="/music/assets/flowbite/flowbite.min.js"></script>
  </body>
</html>
