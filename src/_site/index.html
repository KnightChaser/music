<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>My Music</title>
  </head>
  <body>
    <style>
  /* Import Archivo font */
  @import url('https://fonts.googleapis.com/css2?family=Archivo:wght@400;700&display=swap');

  body {
    font-family: 'Archivo', sans-serif;
  }
  h1.site-title {
    text-align: center;
    margin-top: 1rem;
    font-size: 2rem;
    font-weight: 700;
  }

  .count-container {
    text-align: center;
    margin-bottom: 0.5rem;
    font-size: 1rem;
    color: #555;
  }

  .search-container {
    text-align: center;
    margin: 1.5rem 0;
  }
  .search-container input {
    width: 60%;
    max-width: 500px;
    padding: 0.6rem;
    font-size: 1rem;
    border: 1px solid #888;
    border-radius: 4px;
  }

  table#resultsTable {
    margin: 0 auto;
    border-collapse: collapse;
    /* widen to about 3/4 screen */
    width: 75%;
    font-family: 'Archivo', sans-serif;
  }
  table#resultsTable th,
  table#resultsTable td {
    border: 1px solid #ccc;
    padding: 0.5rem;
  }
  table#resultsTable th {
    background: #f4f4f4;
    cursor: pointer;
  }
  /* center-align Artist, Title, Release, Language */
  table#resultsTable th:nth-child(-n+3),
  table#resultsTable td:nth-child(-n+3),
  table#resultsTable th:nth-last-child(1),
  table#resultsTable td:nth-last-child(1) {
    text-align: center;
  }

  .sort-indicator {
    font-size: 0.8rem;
    margin-left: 0.25rem;
    user-select: none;
  }
  .clickable {
    cursor: pointer;
    color: #0066cc;
    text-decoration: underline;
  }
</style>

<h1 class="site-title">KnightChaserâ€™s Music Curation List</h1>
<div class="count-container" id="count">0 / 0 songs shown</div>

<div class="search-container">
  <input id="search" placeholder="Search by artist, title, mood, tag, note, languageâ€¦" />
</div>

<table id="resultsTable">
  <thead>
    <tr>
      <th class="sortable" data-key="artist">
        Artist <span class="sort-indicator">â‡…</span>
      </th>
      <th class="sortable" data-key="title">
        Title <span class="sort-indicator">â‡…</span>
      </th>
      <th class="sortable" data-key="release">
        Release <span class="sort-indicator">â‡…</span>
      </th>
      <th>Mood</th>
      <th>Tags</th>
      <th>Note</th>
      <th class="sortable" data-key="language">
        Language <span class="sort-indicator">â‡…</span>
      </th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="7" style="text-align:center;">Loadingâ€¦</td></tr>
  </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6"></script>
<script>
  // Language emoji map
  const langEmoji = {
    en: 'ðŸ‡ºðŸ‡¸',
    pt: 'ðŸ‡§ðŸ‡·',
    ja: 'ðŸ‡¯ðŸ‡µ',
    es: 'ðŸ‡ªðŸ‡¸',
    fr: 'ðŸ‡«ðŸ‡·'
  };

  function escapeRegex(s) {
    return s.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');
  }
  function highlight(text, term) {
    if (!term) return text;
    const re = new RegExp('(' + escapeRegex(term) + ')', 'gi');
    return String(text).replace(re, '<strong>$1</strong>');
  }

  fetch('/search.json')
    .then(r => r.json())
    .then(data => {
      const total = data.length;
      const fuse = new Fuse(data, {
        keys: ['artist','title','mood','tags','note','language'],
        threshold: 0.3
      });

      const input   = document.getElementById('search');
      const tbody   = document.querySelector('#resultsTable tbody');
      const countEl = document.getElementById('count');
      let current   = [], sortKey = null, sortDir = 1;

      function updateCount() {
        countEl.textContent = `${current.length} / ${total} songs shown`;
      }

      function applySort() {
        if (!sortKey) return;
        current.sort((a, b) => {
          let av = a[sortKey], bv = b[sortKey];
          if (sortKey === 'release') {
            av = new Date(av); bv = new Date(bv);
          } else {
            av = String(av).toLowerCase();
            bv = String(bv).toLowerCase();
          }
          return (av < bv ? -1 : av > bv ? 1 : 0) * sortDir;
        });
      }

      function render(term) {
        if (!current.length) {
          tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No matches</td></tr>`;
          updateCount();
          return;
        }
        tbody.innerHTML = current.map(item => {
          const t = term.trim();
          const moods = (item.mood||[])
            .map(m => `<span class="clickable" data-term="${m}">#${highlight(m, t)}</span>`)
            .join(' ');
          const tags  = (item.tags||[])
            .map(tag => `<span class="clickable" data-term="${tag}">#${highlight(tag, t)}</span>`)
            .join(' ');
          const note  = item.note ? highlight(item.note, t) : 'N/A';
          const code  = item.language || '';
          const emoji = langEmoji[code] || '';
          const lang  = code
            ? `<span class="clickable" data-term="${code}">${highlight(code, t)}${emoji}</span>`
            : '';

          return `
            <tr>
              <td><span class="clickable" data-term="${item.artist}">${highlight(item.artist, t)}</span></td>
              <td>${highlight(item.title, t)}</td>
              <td>${highlight(item.release, t)}</td>
              <td>${moods}</td>
              <td>${tags}</td>
              <td>${note}</td>
              <td>${lang}</td>
            </tr>`;
        }).join('');
        updateCount();
      }

      function doSearch(term) {
        if (term) {
          current = fuse.search(term).map(r => r.item).slice(0,100);
        } else {
          current = data.slice(0,100);
        }
        applySort();
        render(term);
      }

      // init
      doSearch('');

      // sort clicks
      document.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.dataset.key;
          sortKey = (sortKey === key ? null : key) || key;
          sortDir = (sortKey === key ? -sortDir : 1);
          applySort();
          render(input.value);
        });
      });

      // hashtag/lang clicks
      tbody.addEventListener('click', e => {
        if (e.target.classList.contains('clickable')) {
          const term = e.target.dataset.term;
          if (!input.value.includes(term)) {
            input.value = input.value ? input.value + ' ' + term : term;
            doSearch(input.value);
          }
        }
      });

      // input
      input.addEventListener('input', e => doSearch(e.target.value));
    });
</script>

  </body>
</html>

